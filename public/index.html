<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css" rel="stylesheet" />
    <link href="https://aurora.datasektionen.se" rel="stylesheet" />
    <link href="/style.css" rel="stylesheet" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
<script>
</script>
</head>
<body>
    <div id="application" class="application cerise">
    <div id="methone-container-replace"></div>
    <script type="text/javascript">
        window.methone_conf = {
            system_name: "Pax",
            color_scheme: "cerise",
            login_text: "Ladda om",
            login_href: "/",
            links: []
        }
    </script>
    <script src="//methone.datasektionen.se/bar.js"></script>
    
    <div id="a">
        <div id="list">
            <h2>Dina nØllan</h2>
            <ul>
                <li class="card" v-for="person in Object.keys(n0llan).map(k => n0llan[k]).filter(n => n.paxad && n.paxad.emails === userEmail)">
                    <button class="paxa" @click="socket.emit('avpaxa', { id: person.id })">Avpaxa</button>
                    <h1 v-html="person.name"></h1>
                    <a title="Google Maps" target="_blank" v-bind:href="'https://www.google.com/maps/place/' + person.rawAddress.street + ',+' + person.rawAddress.zip + '+' + person.rawAddress.city" class="address">
                        <i class="fa fa-crosshairs"></i>
                        <span v-html="person.rawAddress.street"></span><br>
                        <span v-html="person.rawAddress.zip"></span>
                        <span v-html="person.rawAddress.city"></span>
                    </a>
                </li>
                <li v-if="Object.keys(n0llan).length === 0">
                    <h2 style="text-align: center">Paxa nØllan genom att hitta dem på kartan till höger</h2>
                </li>
            </ul>
        </div>
    </div>
    </div>
    <div id="map"></div>
    <script type="text/x-template" id="popup-template">
        <div class="popup">
            <h2 v-html="n0llan.name"></h2>
            <p class="address">
                <span v-html="n0llan.rawAddress.street"></span><br />
                <span v-html="n0llan.rawAddress.zip"></span>
                <span v-html="n0llan.rawAddress.city"></span>
            </p>
            <button v-if="!n0llan.paxad" class="paxa" @click="paxa">Paxa</button>
            <button v-if="n0llan.paxad && n0llan.paxad.emails === userEmail" class="paxa" @click="avpaxa">Avpaxa</button>
            <p class="paxare" v-if="n0llan.paxad" v-html="'Paxad av ' + n0llan.paxad.first_name + ' ' + n0llan.paxad.last_name"></p>
        </div>
    </script>
    <script>
        window.PopupContainer = Vue.component('PopupContainer', {
            data() {
                return {
                    userEmail: '',
                    n0llan: {}
                }
            },
            created() {
                console.log('created')
            },
            methods: {
                paxa: function() {
                    this.$emit('paxa', this.n0llan)
                    console.log('paxa')
                },
                avpaxa: function() {
                    this.$emit('avpaxa', this.n0llan)
                    console.log('avpaxa')
                }
            },
            template: '#popup-template'
        })

        const app = new Vue({
            el: '#a',
            data: {
                n0llan: {},
                userEmail: '',
                socket: io({
                    query: {
                        token: location.search.match(/\?(.*&)?token=(.*)\&?/)[2]
                    }
                }),
                map: undefined, 
                popups: {},
                markers: {} 
            },
            created: function() {
                this.socket.on('error', a => console.error(a))
                this.socket.on('ERROR', a => console.error(a))
                this.socket.on('userEmail', ue => this.userEmail = ue)
                this.socket.on('mapToken', token => {
                    mapboxgl.accessToken = token
                    this.map = new mapboxgl.Map({
                        container: 'map',
                        center: [ 18.071440, 59.348135 ],
                        zoom: 11,
                        style: 'mapbox://styles/mapbox/streets-v9'
                    })

                    console.log(mapboxgl, map, token)
                })
                this.socket.on('n0llan', n0llan => {
                    n0llan.forEach(n0llan => {
                        this.update(n0llan)
                    })
                })
                this.socket.on('update', n0llan => {
                    this.update(n0llan)
                })
            },
            methods: {
                update: function (n0llan) {
                    console.log("Updating", n0llan)

                    // Calculate position
                    const coordinates = n0llan.coordinates.longitude && n0llan.coordinates.latitude ? [n0llan.coordinates.longitude, n0llan.coordinates.latitude] : n0llan.addresses[n0llan.index || 0].center

                    const n = this.n0llan
                    n[n0llan.id] = n0llan
                    this.n0llan = n
                    this.$forceUpdate()
                    console.log(this.n0llan)
                    const markerColor = (n0llan) => !n0llan.paxad ? '#ee2a7b' : '#dddddd'

                    const p = new window.PopupContainer()
                    p.n0llan = n0llan
                    p.userEmail = this.userEmail
                    p.$on('paxa', x => this.socket.emit('paxa', { id: x.id }))
                    p.$on('avpaxa', x => this.socket.emit('avpaxa', { id: x.id }))
                    p.$mount()

                    if (this.popups[n0llan.id]) {
                        this.popups[n0llan.id].setDOMContent(p.$el)   
                    } else {
                        this.popups[n0llan.id] = new mapboxgl.Popup().setDOMContent(p.$el).addTo(this.map)
                    }

                    if (this.markers[n0llan.id]) {
                        this.markers[n0llan.id]
                        .setLngLat(coordinates)
                        this.markers[n0llan.id].getElement()
                        .childNodes[0]
                        .childNodes[0]
                        .childNodes[1]
                        .setAttributeNS(null, 'fill', markerColor(n0llan))
                    } else {
                        this.markers[n0llan.id] = new mapboxgl.Marker({
                            color: markerColor(n0llan)
                        })
                        .setLngLat(coordinates)
                        .setPopup(this.popups[n0llan.id])
                        .addTo(this.map)
                    }
                }
            }
        })
    </script>
</body>
</html>
