<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet' />
    <link href='//aurora.datasektionen.se' rel='stylesheet' />
    <link href='/style.css' rel='stylesheet' />
    <script src="/socket.io/socket.io.js"></script>
<script>
</script>
</head>
<body>
    <div id='map'></div>
    <script>
        const socket = io({
            query: {
                token: location.search.match(/\?(.*&)?token=(.*)\&?/)[2]
            }
        })

        const content = {}
        const popups = {}
        const markers = {}

        let map

        const markerColor = ({ paxad }) => paxad ? '#F00' : '#0F0'

        socket.on('error', a => console.error(a))
        socket.on('ERROR', a => console.error(a))

        socket.on('mapToken', token => {
            mapboxgl.accessToken = token
            map = new mapboxgl.Map({
                container: 'map',
                center: [ 18.071440, 59.348135 ],
                zoom: 11,
                style: 'mapbox://styles/mapbox/streets-v9'
            })
        })

        socket.on('n0llan', n0llan => {
            n0llan.forEach(n0llan => {
                const uid = n0llan.uid
                const lngLat = n0llan.addresses[n0llan.index || 0].center

                // Who need templates when you can do this
                const popup = document.createElement('div')

                const name = document.createElement('h1')
                name.appendChild(document.createTextNode(uid))

                const address = document.createElement('p')
                address.appendChild(document.createTextNode(n0llan.rawAddress))

                const paxare = document.createElement('p')
                paxare.style.display = 'none'
                paxare.appendChild(document.createTextNode('Redan paxad av: '))
                paxare.appendChild(document.createTextNode(n0llan.paxad && n0llan.paxad.first_name))
                paxare.appendChild(document.createTextNode(' '))
                paxare.appendChild(document.createTextNode(n0llan.paxad && n0llan.paxad.last_name))
                paxare.appendChild(document.createTextNode(' ('))
                paxare.appendChild(document.createTextNode(n0llan.paxad && n0llan.paxad.emails))
                paxare.appendChild(document.createTextNode(')'))

                if(n0llan.paxad) {
                    paxare.style.display = 'block'
                }

                const paxa = document.createElement('button')
                paxa.appendChild(document.createTextNode('paxa'))
                paxa.onclick = e => socket.emit('paxa', { uid })

                const avpaxa = document.createElement('button')
                avpaxa.appendChild(document.createTextNode('avpaxa'))
                avpaxa.onclick = e => socket.emit('avpaxa', { uid })

                const alternatives = document.createElement('select')
                n0llan.addresses.forEach((address, index) => {
                    const option = document.createElement('option')
                    option.appendChild(document.createTextNode(address.place_name))
                    option.value = index
                    alternatives.appendChild(option)
                })

                alternatives.onchange = e =>
                    socket.emit('fixa', { uid, index: parseInt(e.target.value) })


                popup.appendChild(name)
                popup.appendChild(address)
                popup.appendChild(paxare)
                popup.appendChild(paxa)
                popup.appendChild(avpaxa)
                popup.appendChild(alternatives)

                content[uid] = popup

                popups[uid] = new mapboxgl.Popup()
                    .setDOMContent(popup)
                    .addTo(map)

                markers[uid] = new mapboxgl.Marker({
                    color: markerColor(n0llan)
                })
                    .setLngLat(lngLat)
                    .setPopup(popups[uid])
                    .addTo(map)
            })
        })

        socket.on('update', n0llan => {
            const marker = markers[n0llan.uid]
            marker.getElement()
                .childNodes[0]
                .childNodes[0]
                .childNodes[1]
                .setAttributeNS(null, 'fill', markerColor(n0llan))

            marker.setLngLat(n0llan.features[n0llan.index || 0].center)

            const paxare = content[n0llan.uid].childNodes[2]
            if(n0llan.paxad) {
                paxare.childNodes[1].innerText = n0llan.paxad.first_name
                paxare.childNodes[3].innerText = n0llan.paxad.last_name
                paxare.childNodes[5].innerText = n0llan.paxad.emails
                paxare.style.display = 'block'
            } else {
                paxare.style.display = 'none'
            }
        })

    </script>
</body>
</html>
